<html>
  <head>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <title>PsiFi XVII</title>
    <style type="text/css">
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        background: #000000;
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        overflow-x: hidden;
      }

      /* Background with gradient like home page */
      .background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          135deg,
          #000000 0%,
          #030a06 42%,
          #082015 70%,
          #062a14 100%
        );
        background-attachment: fixed;
        z-index: 1;
      }

      .background::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: radial-gradient(
            circle at 25% 25%,
            rgba(5, 59, 5, 0.03) 1px,
            transparent 1px
          ),
          radial-gradient(
            circle at 75% 75%,
            rgba(0, 20, 0, 0.02) 1px,
            transparent 1px
          );
        background-size: 50px 50px;
        opacity: 0.8;
      }

      /* Floating Orbs */
      .background-elements {
        position: fixed;
        inset: 0;
        overflow: hidden;
        z-index: 2;
        pointer-events: none;
      }

      .floating-orb {
        filter: blur(64px);
        opacity: 0.4;
        border-radius: 50%;
      }

      .orb-1 {
        width: 320px;
        height: 320px;
        background: radial-gradient(
          circle at 30% 30%,
          rgba(12, 134, 96, 0.45),
          rgba(4, 30, 18, 0.65)
        );
        position: absolute;
        top: -10%;
        left: -5%;
      }
      .orb-2 {
        width: 420px;
        height: 420px;
        background: radial-gradient(
          circle at 70% 40%,
          rgba(24, 160, 80, 0.45),
          rgba(3, 18, 10, 0.65)
        );
        position: absolute;
        bottom: -15%;
        right: -10%;
      }
      .orb-3 {
        width: 360px;
        height: 360px;
        background: radial-gradient(
          circle at 50% 50%,
          rgba(6, 92, 70, 0.35),
          rgba(0, 0, 0, 0.7)
        );
        position: absolute;
        top: 40%;
        right: 5%;
      }

      /* Floating Particles */
      .particles-container {
        position: fixed;
        inset: 0;
        overflow: hidden;
        z-index: 2;
        pointer-events: none;
      }

      .particle {
        position: absolute;
        width: 6px;
        height: 6px;
        background: rgba(255, 255, 255, 0.12);
        border-radius: 50%;
        animation: particleFloat 8s linear infinite;
        box-shadow: 0 0 8px rgba(255, 255, 255, 0.15);
      }

      .particle:nth-child(odd) {
        animation-duration: 6s;
      }
      .particle:nth-child(even) {
        animation-duration: 10s;
      }

      @keyframes particleFloat {
        0% {
          transform: translateY(100vh) rotate(0deg);
          opacity: 0;
        }
        10% {
          opacity: 1;
        }
        90% {
          opacity: 1;
        }
        100% {
          transform: translateY(-100px) rotate(360deg);
          opacity: 0;
        }
      }

      /* Minimal Chameleon Style CSS - Let Cognito handle most formatting */
      .form-container {
        position: relative;
        z-index: 10;
        width: 100%;
        min-height: 100vh;
        overflow: auto;
        padding: 40px 20px;
        box-sizing: border-box;
      }

      /* Form wrapper - minimal styling */
      .form-container .cognito {
        background: rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(8px);
        border-radius: 12px;
        padding: 20px;
        border: 1px solid rgba(51, 204, 51, 0.2);
        margin: 0 auto;
      }

      /* Only override essential colors for dark theme */
      .form-container .c-forms-form {
        background: transparent !important;
      }

      /* Labels - make them visible on dark background */
      .form-container label,
      .form-container .c-forms-label {
        color: #ffffff !important;
      }

      /* Question text */
      .form-container .c-forms-question {
        color: #ffffff !important;
      }

      /* Input fields - minimal override */
      .form-container input[type="text"],
      .form-container input[type="email"],
      .form-container input[type="tel"],
      .form-container input[type="number"],
      .form-container textarea,
      .form-container select {
        background: #ffffff !important;
        color: #000000 !important;
      }

      /* Placeholder text */
      .form-container input::placeholder,
      .form-container textarea::placeholder {
        color: #666666 !important;
      }

      /* Dropdown options - make text black */
      .form-container select option {
        color: #000000 !important;
        background: #ffffff !important;
      }

      /* Cognito choice elements */
      .form-container .cog-choice--dropdown,
      .form-container .cog-choice--radiobuttons,
      .form-container .cog-choice--checkboxes {
        color: #000000 !important;
      }

      /* Cognito dropdown menus */
      .form-container .c-forms-dropdown-option,
      .form-container .c-forms-select-option {
        color: #000000 !important;
        background: #ffffff !important;
      }

      .form-container .c-forms-dropdown-option:hover,
      .form-container .c-forms-select-option:hover {
        color: #000000 !important;
        background: #f0f0f0 !important;
      }

      /* Element UI input components */
      .form-container .el-input__inner {
        background: #ffffff !important;
        color: #000000 !important;
        border: 1px solid #dcdfe6 !important;
      }

      /* Element UI dropdown options - multiple selectors */
      .el-select-dropdown__item,
      .el-option,
      .form-container .el-select-dropdown__item,
      .form-container .el-option,
      .el-select-dropdown .el-select-dropdown__item,
      body .el-select-dropdown__item {
        color: #000000 !important;
        background: #ffffff !important;
      }

      .el-select-dropdown__item:hover,
      .el-option:hover,
      .form-container .el-select-dropdown__item:hover,
      .form-container .el-option:hover,
      .el-select-dropdown .el-select-dropdown__item:hover,
      body .el-select-dropdown__item:hover {
        color: #000000 !important;
        background: #f5f7fa !important;
      }

      /* Element UI dropdown list - target globally */
      .el-select-dropdown,
      .el-popper,
      .form-container .el-select-dropdown,
      .form-container .el-popper,
      body .el-select-dropdown {
        background: #ffffff !important;
        border: 1px solid #e4e7ed !important;
      }

      /* Try targeting by aria attributes */
      [role="listbox"],
      [role="option"],
      [id*="listbox"],
      [id*="option"] {
        color: #000000 !important;
        background: #ffffff !important;
      }

      /* Cognito specific dropdown targeting */
      [id*="cog-"][id*="-listbox"],
      [id*="cog-"][id*="-option"] {
        color: #000000 !important;
        background: #ffffff !important;
      }

      /* Dropdown option items specifically */
      .form-container .cog-choice--dropdown option,
      .form-container .cog-choice--dropdown select option {
        color: #000000 !important;
        background: #ffffff !important;
      }

      /* Radio button and checkbox labels */
      .form-container .c-forms-choice-label {
        color: #ffffff !important;
      }

      /* Buttons - use theme colors but keep default styling */
      .form-container button,
      .form-container input[type="submit"],
      .form-container .c-forms-button {
        background: linear-gradient(
          135deg,
          #17501c 0%,
          #003122 100%
        ) !important;
        border-color: #33cc33 !important;
        color: #ffffff !important;
      }

      .form-container button:hover,
      .form-container input[type="submit"]:hover,
      .form-container .c-forms-button:hover {
        background: linear-gradient(
          135deg,
          #1c6b22 0%,
          #004d33 100%
        ) !important;
      }

      /* Navigation buttons (Next, Back, Save) - ensure they show */
      .form-container .c-forms-navigation button,
      .form-container .c-forms-navigation input[type="submit"],
      .form-container button[type="button"] {
        background: linear-gradient(
          135deg,
          #17501c 0%,
          #003122 100%
        ) !important;
        border: 1px solid #33cc33 !important;
        color: #ffffff !important;
        display: inline-block !important;
        visibility: visible !important;
        opacity: 1 !important;
      }

      /* Progress bar */
      .form-container .c-forms-progress-bar {
        background-color: rgba(51, 204, 51, 0.2) !important;
      }

      .form-container .c-forms-progress-bar-fill {
        background-color: #33cc33 !important;
      }

      /* Form title */
      .form-container .c-forms-form-title {
        color: #ffffff !important;
        text-align: center;
        margin-bottom: 20px;
      }

      /* Make sure all buttons are visible */
      .form-container button,
      .form-container input[type="button"],
      .form-container input[type="submit"] {
        display: inline-block !important;
        visibility: visible !important;
        opacity: 1 !important;
      }

      /* Specifically target back button if it has a specific class */
      .form-container .c-forms-button-back,
      .form-container [data-button="back"],
      .form-container button[onclick*="back"],
      .form-container button[onclick*="previous"] {
        display: inline-block !important;
        visibility: visible !important;
        opacity: 1 !important;
        background: linear-gradient(
          135deg,
          #17501c 0%,
          #003122 100%
        ) !important;
        border: 1px solid #33cc33 !important;
        color: #ffffff !important;
      }

      /* Hide Cognito branding */
      .form-container .c-forms-branding {
        display: none !important;
      }

      /* Comprehensive Cognito Form Styling using CSS Variables and ID targeting */
      #psifi-form .cog-cognito {
        --form__background-color: transparent !important;
        --input__background-color: rgba(26, 32, 46, 0.8) !important;
        --input__text-color: white !important;
        --button-primary__background-color: #6366f1 !important;
        --button-primary__text-color: white !important;
        --text-color: white !important;
        --label-color: white !important;
        --field-label-color: white !important;
      }

      /* Universal text selector - ensures ALL text elements are white */
      #psifi-form .cog-cognito * {
        color: white !important;
      }

      #psifi-form .cog-cognito .cog-section {
        background: transparent !important;
        color: white !important;
      }

      #psifi-form .cog-cognito .cog-field input,
      #psifi-form .cog-cognito .cog-field select,
      #psifi-form .cog-cognito .cog-field textarea {
        background: rgba(26, 32, 46, 0.8) !important;
        border: 1px solid rgba(99, 102, 241, 0.5) !important;
        color: white !important;
      }

      #psifi-form .cog-cognito .cog-field label,
      #psifi-form .cog-cognito label,
      #psifi-form .cog-cognito p,
      #psifi-form .cog-cognito span,
      #psifi-form .cog-cognito div,
      #psifi-form .cog-cognito h1,
      #psifi-form .cog-cognito h2,
      #psifi-form .cog-cognito h3,
      #psifi-form .cog-cognito h4,
      #psifi-form .cog-cognito h5,
      #psifi-form .cog-cognito h6 {
        color: white !important;
      }

      /* Placeholder text styling */
      #psifi-form .cog-cognito input::placeholder,
      #psifi-form .cog-cognito textarea::placeholder {
        color: rgba(255, 255, 255, 0.7) !important;
      }

      .header {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-direction: row;
        padding: 15px 50px;
        z-index: 11;
      }

      .dashboard-btn {
        position: relative;
        z-index: 10;
        background: linear-gradient(135deg, #17501c 0%, #003122 100%);
        color: #fff;
        padding: 0.6rem 1.2rem;
        border-radius: 2rem;
        border: none;
        font-size: 1rem;
        font-weight: 600;
        box-shadow: 0 2px 10px rgba(23, 80, 28, 0.25);
        cursor: pointer;
        text-decoration: none;
        transition: all 0.3s ease;
      }
      /* Style Cognito Save Dialog/Modal */
      .cog-dialog,
      .cog-modal,
      .cog-overlay,
      .cog-confirm-dialog {
        z-index: 11 !important;
        background: rgba(0, 0, 0, 0.8) !important;
        backdrop-filter: blur(10px) !important;
      }

      .cog-dialog__content,
      .cog-modal__content,
      .cog-confirm-dialog__content {
        background: linear-gradient(
          135deg,
          #1a1a1a 0%,
          #0d2818 100%
        ) !important;
        border: 1px solid rgba(51, 204, 51, 0.3) !important;
        border-radius: 12px !important;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5) !important;
        color: #ffffff !important;
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif !important;
        max-width: 90vw !important;
        max-height: 90vh !important;
        overflow: auto !important;
        padding: 24px !important;
      }

      /* Dialog text styling */
      .cog-dialog__content h1,
      .cog-dialog__content h2,
      .cog-dialog__content h3,
      .cog-modal__content h1,
      .cog-modal__content h2,
      .cog-modal__content h3 {
        color: #33cc33 !important;
        margin-bottom: 16px !important;
      }

      .cog-dialog__content p,
      .cog-modal__content p {
        color: #e0e0e0 !important;
        line-height: 1.5 !important;
        margin-bottom: 12px !important;
      }

      /* Dialog buttons */
      .cog-dialog__content button,
      .cog-modal__content button,
      .cog-confirm-dialog__content button {
        background: linear-gradient(
          135deg,
          #17501c 0%,
          #003122 100%
        ) !important;
        border: 1px solid rgba(51, 204, 51, 0.4) !important;
        border-radius: 8px !important;
        color: #ffffff !important;
        cursor: pointer !important;
        font-size: 14px !important;
        font-weight: 600 !important;
        padding: 12px 24px !important;
        margin: 8px 4px !important;
        transition: all 0.3s ease !important;
      }

      .cog-dialog__content button:hover,
      .cog-modal__content button:hover,
      .cog-confirm-dialog__content button:hover {
        background: linear-gradient(
          135deg,
          #1c6b22 0%,
          #004d33 100%
        ) !important;
        transform: translateY(-2px) !important;
        box-shadow: 0 8px 20px rgba(23, 80, 28, 0.3) !important;
      }
      /* Success/Error message styling */
      .cog-success-message {
        background: rgba(51, 204, 51, 0.1) !important;
        border: 1px solid rgba(51, 204, 51, 0.3) !important;
        border-radius: 8px !important;
        color: #33cc33 !important;
        padding: 16px !important;
        margin: 16px 0 !important;
      }

      .cog-error-message {
        background: rgba(255, 51, 51, 0.1) !important;
        border: 1px solid rgba(255, 51, 51, 0.3) !important;
        border-radius: 8px !important;
        color: #ff6666 !important;
        padding: 16px !important;
        margin: 16px 0 !important;
      }

      /* Make dialog responsive */
      @media (max-width: 768px) {
        .cog-dialog__content,
        .cog-modal__content,
        .cog-confirm-dialog__content {
          max-width: 95vw !important;
          max-height: 85vh !important;
          padding: 16px !important;
          margin: 20px auto !important;
        }
      }
      */ .dashboard-btn:hover {
        transform: translateY(-2px) scale(1.02);
        box-shadow: 0 14px 40px rgba(23, 80, 28, 0.3);
        background: linear-gradient(135deg, #1c6b22 0%, #003122 100%);
      }

      /* Custom scrollbar to match theme */
      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb {
        background: rgba(51, 204, 51, 0.3);
        border-radius: 4px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      ::-webkit-scrollbar-thumb:hover {
        background: rgba(51, 204, 51, 0.5);
        border-color: rgba(255, 255, 255, 0.2);
      }

      /* For Firefox */
      * {
        scrollbar-width: thin;
        scrollbar-color: rgba(51, 204, 51, 0.3) rgba(0, 0, 0, 0.1);
      }
    </style>
  </head>
  <body>
    <!-- Background Elements -->
    <div class="background"></div>

    <!-- Floating Orbs -->
    <div class="background-elements">
      <div class="floating-orb orb-1"></div>
      <div class="floating-orb orb-2"></div>
      <div class="floating-orb orb-3"></div>
    </div>

    <!-- Floating Particles -->
    <div class="particles-container">
      <div class="particle" style="left: 10%; animation-delay: 0s"></div>
      <div class="particle" style="left: 20%; animation-delay: 1s"></div>
      <div class="particle" style="left: 30%; animation-delay: 2s"></div>
      <div class="particle" style="left: 40%; animation-delay: 3s"></div>
      <div class="particle" style="left: 50%; animation-delay: 4s"></div>
      <div class="particle" style="left: 60%; animation-delay: 5s"></div>
      <div class="particle" style="left: 70%; animation-delay: 6s"></div>
      <div class="particle" style="left: 80%; animation-delay: 7s"></div>
      <div class="particle" style="left: 90%; animation-delay: 8s"></div>
      <div class="particle" style="left: 15%; animation-delay: 9s"></div>
      <div class="particle" style="left: 25%; animation-delay: 10s"></div>
      <div class="particle" style="left: 35%; animation-delay: 11s"></div>
      <div class="particle" style="left: 45%; animation-delay: 12s"></div>
      <div class="particle" style="left: 55%; animation-delay: 13s"></div>
      <div class="particle" style="left: 65%; animation-delay: 14s"></div>
      <div class="particle" style="left: 75%; animation-delay: 15s"></div>
      <div class="particle" style="left: 85%; animation-delay: 16s"></div>
      <div class="particle" style="left: 95%; animation-delay: 17s"></div>
      <div class="particle" style="left: 5%; animation-delay: 18s"></div>
      <div class="particle" style="left: 95%; animation-delay: 19s"></div>
    </div>
    <div class="header">
      <img
        src="../../static/images/logo_psifi.png"
        alt=""
        style="max-width: 100px; z-index: 20; position: relative"
      />
      <a href="/dashboard/" class="dashboard-btn">Dashboard</a>
    </div>
    <div id="psifi-form" class="form-container">
      <script
        src="https://www.cognitoforms.com/f/seamless.js"
        data-key="B1EGXzUdukiPlRx54XWcPQ"
        data-form="1"
        data-style="chameleon"
        data-save="true"
      ></script>
    </div>

    <!-- Auto-save Form State JavaScript -->
    <script>
      // Helper: try to read amount from DOM span with data-id="TotalFee"
      function getTotalFromDOM() {
        try {
          const el = document.querySelector('[data-id="TotalFee"]');
          if (!el) return null;
          const raw = (el.innerText || el.textContent || "").trim();
          let digits = "";
          for (let i = 0; i < raw.length; i++) {
            const c = raw[i];
            if (c >= "0" && c <= "9") digits += c;
          }
          return digits ? parseInt(digits, 10) : null;
        } catch (_) {
          return null;
        }
      }

      // Calculate TotalFee using your full formula (robust parsing + fallbacks)
      function calculateTotalFee(entry) {
        try {
          const toNumber = (val) => {
            if (val === null || val === undefined) return 0;
            if (typeof val === "number" && !Number.isNaN(val)) return val;
            if (typeof val === "string") {
              const cleaned = val.replace(/[^0-9.-]/g, "");
              return cleaned ? parseFloat(cleaned) : 0;
            }
            return 0;
          };

          const get = (obj, path) => {
            try {
              const parts = path.split(".");
              let cur = obj;
              for (const p of parts) {
                if (cur && typeof cur === "object" && p in cur) {
                  cur = cur[p];
                } else {
                  return undefined;
                }
              }
              return cur;
            } catch (_) {
              return undefined;
            }
          };

          // TotalNights = Nights2 + Nights22 + Nights3 + TeamMember3Information.Nights4 + TeamMember4Information.Nights5
          const nights2 = toNumber(entry.Nights2);
          const nights22 = toNumber(entry.Nights22);
          const nights3 = toNumber(entry.Nights3);
          const nights4 = toNumber(
            get(entry, "TeamMember3Information.Nights4")
          );
          const nights5 = toNumber(
            get(entry, "TeamMember4Information.Nights5")
          );
          const totalNights = nights2 + nights22 + nights3 + nights4 + nights5;

          // RegistrationPhase = "" if no submitted date, else based on cutoff 25 Oct of current year
          const submittedRaw =
            get(entry, "Entry.DateSubmitted") ||
            entry.DateSubmitted ||
            entry.Submitted ||
            null;
          const submitted = submittedRaw ? new Date(submittedRaw) : null;
          const now = new Date();
          const cutoff = new Date(`${now.getFullYear()}-10-25T23:59:59`);
          let registrationPhase = "";
          if (submitted instanceof Date && !Number.isNaN(submitted.getTime())) {
            registrationPhase =
              submitted.getTime() <= cutoff.getTime()
                ? "Regular Phase"
                : "Early Bird";
          }

          // EventsPrice by phase + number of events, multiplied by team size (3/4/5)
          const eventsChoice = (
            entry.SelectTheNumberOfEventsYouWishToParticipateIn || ""
          ).toString();
          const teamSizeStr = (entry.TeamSize || "").toString();
          const teamCount = teamSizeStr.startsWith("3")
            ? 3
            : teamSizeStr.startsWith("4")
            ? 4
            : teamSizeStr.startsWith("5")
            ? 5
            : 0;
          let perPerson = 0;
          if (registrationPhase === "Early Bird") {
            perPerson = eventsChoice === "2 Events" ? 7500 : 8500;
          } else if (registrationPhase === "Regular Phase") {
            perPerson = eventsChoice === "2 Events" ? 8500 : 9500;
          } else if (registrationPhase === "Late Phase") {
            perPerson = eventsChoice === "2 Events" ? 11000 : 12000;
          } else {
            perPerson = 0;
          }
          const eventsPrice = perPerson * teamCount;

          // AccommodationPrice & DelegationFee depend on phase (Late=2000 else 1500) times total nights
          const perNight = registrationPhase === "Late Phase" ? 2000 : 1500;
          const accommodationPrice = totalNights * perNight;
          const delegationFee = totalNights * perNight;

          const total = accommodationPrice + delegationFee + eventsPrice;
          console.log("Calculated TotalFee:", {
            nights2,
            nights22,
            nights3,
            nights4,
            nights5,
            totalNights,
            submittedRaw,
            registrationPhase,
            eventsChoice,
            teamSizeStr,
            teamCount,
            perPerson,
            perNight,
            accommodationPrice,
            delegationFee,
            eventsPrice,
            total,
            allEntryKeys: Object.keys(entry || {}),
          });

          return total;
        } catch (e) {
          console.error("Error calculating TotalFee:", e);
          return null;
        }
      }
      // After successful Cognito submission: save payment link (no redirect)
      // Primary: Cognito event API
      (function attachCognitoHandlers() {
        if (window.Cognito && typeof window.Cognito.on === "function") {
          window.Cognito.on("afterSubmit", function (event) {
            try {
              const entry =
                event && event.data && event.data.entry ? event.data.entry : {};
              try {
                console.log(
                  "afterSubmit entry keys:",
                  Object.keys(entry || {})
                );
              } catch (_) {}

              // Try to get TotalFee from entry first
              let total =
                (entry && (entry.TotalFee || entry.total || entry.Total)) ||
                null;

              // If not found, calculate it using our formula
              if (total == null) {
                total = calculateTotalFee(entry);
                try {
                  console.log("afterSubmit calculated TotalFee:", total);
                } catch (_) {}
              }

              // Last resort: try DOM
              if (total == null) {
                const domTotal = getTotalFromDOM();
                try {
                  console.log("afterSubmit DOM TotalFee:", domTotal);
                } catch (_) {}
                total = domTotal;
              }
              fetch("/api/create-payment/", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ entry, amount: total }),
              })
                .then((r) => r.json())
                .then((res) => {
                  // Do not redirect; just log/save
                  try {
                    console.log("Payment link stored:", res && res.payment_url);
                  } catch (_) {}
                })
                .catch((err) =>
                  console.error("Payment link creation failed", err)
                );
            } catch (e) {
              console.error("afterSubmit handler error", e);
            }
          });
        }
      })();

      // Fallback: window message listener (no redirect)
      window.addEventListener("message", function (e) {
        try {
          const msg = e.data || {};
          if (msg.event === "afterSubmit" || msg.type === "afterSubmit") {
            const entry = msg.entry || msg.data || {};
            try {
              console.log(
                "message afterSubmit entry keys:",
                Object.keys(entry || {})
              );
            } catch (_) {}

            // Try to get TotalFee from entry first
            let total =
              (entry && (entry.TotalFee || entry.total || entry.Total)) || null;

            // If not found, calculate it using our formula
            if (total == null) {
              total = calculateTotalFee(entry);
              try {
                console.log("message calculated TotalFee:", total);
              } catch (_) {}
            }

            // Last resort: try DOM
            if (total == null) {
              const domTotal = getTotalFromDOM();
              try {
                console.log("message DOM TotalFee:", domTotal);
              } catch (_) {}
              total = domTotal;
            }
            fetch("/api/create-payment/", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ entry, amount: total }),
            })
              .then((r) => r.json())
              .then((res) => {
                try {
                  console.log(
                    "Payment link stored (fallback):",
                    res && res.payment_url
                  );
                } catch (_) {}
              })
              .catch(() => {});
          }
        } catch (err) {}
      });

      // Auto-save form state every 30 seconds and on form changes
      let saveTimeout;
      let formLoaded = false;

      // Function to get CSRF token
      function getCsrfToken() {
        const name = "csrftoken";
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + "=") {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }

      // Function to get all form data
      function getFormData() {
        const formData = {};
        const forms = document.querySelectorAll("form");

        forms.forEach((form) => {
          // Get all input values
          const inputs = form.querySelectorAll("input, select, textarea");
          inputs.forEach((input) => {
            if (input.name || input.id) {
              const key = input.name || input.id;
              if (input.type === "checkbox" || input.type === "radio") {
                formData[key] = input.checked;
              } else if (input.type === "file") {
                // Don't save file inputs, just note that they exist
                if (input.files && input.files.length > 0) {
                  formData[key] = `FILE_SELECTED: ${input.files[0].name}`;
                }
              } else {
                formData[key] = input.value;
              }
            }
          });
        });

        return formData;
      }

      // Function to populate form with saved data
      function populateForm(data) {
        if (!data || Object.keys(data).length === 0) return;

        const forms = document.querySelectorAll("form");

        forms.forEach((form) => {
          Object.keys(data).forEach((key) => {
            const input = form.querySelector(`[name="${key}"], [id="${key}"]`);
            if (input && !key.startsWith("FILE_SELECTED:")) {
              if (input.type === "checkbox" || input.type === "radio") {
                input.checked = data[key];
              } else if (input.type !== "file") {
                input.value = data[key];
                // Trigger change event to update Cognito's internal state
                input.dispatchEvent(new Event("change", { bubbles: true }));
              }
            }
          });
        });
      }

      // Function to capture Cognito's save link and store it
      function captureCognitoSaveLink() {
        // Look for Cognito's save link in various possible locations
        const possibleSelectors = [
          'a[href*="cognitoforms.com"][href*="saved"]',
          "[data-cognito-save-url]",
          ".cognito-save-link",
          'a[href*="resume"]',
          'a[href*="continue"]',
        ];

        let saveUrl = null;

        // Check URL parameters first (Cognito might add the save URL to the current page URL)
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get("saved") || urlParams.get("resume")) {
          saveUrl = window.location.href;
        }

        // Check for save links in the DOM
        for (const selector of possibleSelectors) {
          const element = document.querySelector(selector);
          if (element && element.href) {
            saveUrl = element.href;
            break;
          }
        }

        // Check for save URL in Cognito's internal state (if accessible)
        if (window.Cognito && window.Cognito.saveUrl) {
          saveUrl = window.Cognito.saveUrl;
        }

        // If we found a save URL, store it
        if (saveUrl) {
          console.log("Cognito save URL captured:", saveUrl);
          storeCognitoSaveUrl(saveUrl);
          return saveUrl;
        }

        return null;
      }

      // Function to store Cognito's save URL in our backend
      function storeCognitoSaveUrl(saveUrl) {
        fetch("/save-cognito-url/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCsrfToken(),
          },
          body: JSON.stringify({ save_url: saveUrl }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              console.log("Cognito save URL stored successfully");
              showSaveIndicator();
            } else {
              console.error("Error storing Cognito save URL:", data.error);
            }
          })
          .catch((error) =>
            console.error("Error storing Cognito save URL:", error)
          );
      }

      // Function to save form state (fallback method)
      function saveFormState() {
        // First try to capture Cognito's save link
        const saveUrl = captureCognitoSaveLink();

        if (!saveUrl) {
          // Fallback to manual form data capture
          const formData = getFormData();
          if (Object.keys(formData).length === 0) return;

          fetch("/save-form-state/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": getCsrfToken(),
            },
            body: JSON.stringify(formData),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                console.log("Form state saved successfully");
                showSaveIndicator();
              } else {
                console.error("Error saving form state:", data.error);
              }
            })
            .catch((error) => console.error("Error saving form state:", error));
        }
      }

      // Function to load form state
      function loadFormState() {
        fetch("/load-form-state/")
          .then((response) => response.json())
          .then((result) => {
            if (result.success) {
              // Check if we have a Cognito save URL
              if (result.cognito_save_url) {
                console.log(
                  "Found Cognito save URL, redirecting:",
                  result.cognito_save_url
                );
                // Redirect to Cognito's save URL to resume the form
                window.location.href = result.cognito_save_url;
                return;
              }

              // Fallback to manual form data population
              if (result.data) {
                setTimeout(() => {
                  populateForm(result.data);
                  formLoaded = true;
                  console.log("Form state loaded successfully");
                  if (Object.keys(result.data).length > 0) {
                    showLoadIndicator();
                  }
                }, 3000);
              } else {
                formLoaded = true;
              }
            } else {
              formLoaded = true;
            }
          })
          .catch((error) => {
            console.error("Error loading form state:", error);
            formLoaded = true;
          });
      }

      // Function to show save indicator
      function showSaveIndicator() {
        const indicator = document.createElement("div");
        indicator.textContent = "Progress saved ✓";
        indicator.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(51, 204, 51, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        `;

        document.body.appendChild(indicator);

        // Fade in
        setTimeout(() => (indicator.style.opacity = "1"), 100);

        // Fade out and remove
        setTimeout(() => {
          indicator.style.opacity = "0";
          setTimeout(() => {
            if (document.body.contains(indicator)) {
              document.body.removeChild(indicator);
            }
          }, 300);
        }, 2000);
      }

      // Function to show load indicator
      function showLoadIndicator() {
        const indicator = document.createElement("div");
        indicator.textContent = "Previous progress restored ↻";
        indicator.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(99, 102, 241, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        `;

        document.body.appendChild(indicator);

        // Fade in
        setTimeout(() => (indicator.style.opacity = "1"), 100);

        // Fade out and remove
        setTimeout(() => {
          indicator.style.opacity = "0";
          setTimeout(() => {
            if (document.body.contains(indicator)) {
              document.body.removeChild(indicator);
            }
          }, 300);
        }, 3000);
      }

      // Debounced auto-save function
      function debouncedSave() {
        if (!formLoaded) return;

        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(saveFormState, 2000); // Save 2 seconds after last change
      }

      document.addEventListener("DOMContentLoaded", function () {
        // Wait for the Cognito iframe to appear
        const observer = new MutationObserver(() => {
          const iframe = document.querySelector(
            'iframe[src*="cognitoforms.com"]'
          );
          if (iframe) {
            // Stop observing once found
            observer.disconnect();

            let lastUrl = iframe.src;

            // Observe src changes to catch new resume URLs
            const checkInterval = setInterval(() => {
              if (iframe.src !== lastUrl) {
                lastUrl = iframe.src;
                console.log("🔗 New Cognito Form URL detected:", lastUrl);

                // Example: store it in localStorage or send to backend
                localStorage.setItem("cognitoFormURL", lastUrl);
                fetch("/api/save-form-url/", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ form_url: lastUrl }),
                }).catch((e) => console.error("Error saving form URL:", e));
              }
            }, 1500);
          }
        });

        observer.observe(document.body, { childList: true, subtree: true });
      });
      window.addEventListener("message", (event) => {
        // Only listen to Cognito Form messages
        if (!event.origin.includes("cognitoforms.com")) return;

        // Look for a message that includes an "edit" or "update" URL
        if (event.data && typeof event.data === "string") {
          const match = event.data.match(
            /https:\/\/www\.cognitoforms\.com\/.*/
          );
          if (match) {
            const formEditUrl = match[0];
            console.log("🧩 Captured Cognito Edit URL:", formEditUrl);

            // Save it locally so you can restore it when user comes back
            localStorage.setItem("cognitoEditUrl", formEditUrl);
          }
        }
      });

      window.addEventListener("load", () => {
        const script = document.querySelector(
          'script[src*="cognitoforms.com/f/seamless.js"]'
        );
        if (script) {
          console.log("script", script);
          const key = script.getAttribute("data-key");
          const form = script.getAttribute("data-form");
          const link = `https://www.cognitoforms.com/f/${key}?id=${form}`;
          console.log("Extracted Cognito Form Link:", link);
        } else {
          console.log("No Cognito form script found.");
        }
      });
    </script>
  </body>
</html>
